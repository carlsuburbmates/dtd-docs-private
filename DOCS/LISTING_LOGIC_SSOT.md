## 1. System summary
A “listing” is a row in `businesses` (supabase/schema.sql:131-157) representing a dog trainer profile, optionally linked to an authenticated owner (`profiles.id`) and augmented with specializations/services, reviews, and ABN verification metadata. Listings enter the system through user onboarding (`POST /api/onboarding`, src/app/api/onboarding/route.ts), scaffold import SQL (`supabase/phase2_scaffolded.sql` generated by scripts/run_phase2_scraper.py and scripts/apply_phase2_scaffolded.py), or admin approval (`POST /api/admin/scaffolded`, src/app/api/admin/scaffolded/route.ts). Once inserted and marked `is_active=true`/`is_deleted=false`, they become queryable through the `search_trainers` RPC (supabase/migrations/20250210153000_search_trainers_accept_key.sql) which powers public pages like `/directory` and homepage triage results, although several UI surfaces call placeholder data sources today.

## 2. Listing creation entry points
### /api/onboarding (src/app/api/onboarding/route.ts, `POST`)
- **Required request fields:** `email`, `password`, `businessName`, `abn`; optional `businessPhone`, `businessEmail`, `website`, `address`, `suburbId`, `bio`, `pricing`, `ages`, `issues`, `primaryService`, `secondaryServices`. Body parsed at lines 50-68.
- **Process:** Creates Supabase auth user (`supabaseAdmin.auth.admin.createUser`, line 75), inserts into `profiles` (line 108), writes to `businesses` with encrypted contact data and ABN flags (lines 115-133).
- **Associated tables:** Inserts to `trainer_specializations` (lines 163-169), attempts `trainer_behaviors` (line 171) though the schema table is `trainer_behavior_issues`, inserts `trainer_services` (lines 179-182) but uses column name `service` instead of `service_type`, and writes `abn_verifications` with `matched_json` (lines 184-201). Optionally records `abn_fallback_events` via `recordAbnFallbackEvent` (lines 156-160).
- **Deduplication:** None; there is no ABN/name pre-check before inserting new businesses or specializations.

### Phase 2 scaffold scripts
- **Source CSV:** `DOCS/phase2_scraper_targets.csv` consumed by `scripts/run_phase2_scraper.py` (lines 55-88). Each CSV row must include `url`, `name`, `phone`, `email`, `suburb`, `lga`, `age_hint`, `issue_hint`, `service_hint`, `abn`. Script maps hints to enum arrays (AGE_ENUM, ISSUE_ENUM, SERVICE_ENUM at lines 6-36) and writes `supabase/phase2_scraped.json`.
- **SQL renderer:** `scripts/apply_phase2_scaffolded.py` (lines 24-64) reads the JSON when `SCRAPER_ENABLED` is true and emits `supabase/phase2_scaffolded.sql`, inserting into `businesses` (`is_scaffolded=true`, `is_claimed=false`, `verification_status='manual_review'`), `trainer_specializations`, `trainer_behavior_issues`, `trainer_services` (with `service_type`/`is_primary`), and `abn_verifications` (`verification_method='manual_upload'`). The generated SQL performs no dedupe or conflict checks; it assumes matching suburbs exist via `(SELECT id FROM suburbs WHERE name='<suburb>' LIMIT 1)`.
- **Execution:** Operators must run the SQL manually against the database; there is no CLI integration beyond file generation.

### Admin scaffold approve/reject (src/app/api/admin/scaffolded/route.ts)
- **GET** returns `businesses` where `is_scaffolded=true` and `verification_status='manual_review'` (lines 6-17) for queue display.
- **POST** requires JSON `{ id, action }` (lines 22-27). Approve sets `is_scaffolded=false`, `is_claimed=true`, `verification_status='verified'`, `abn_verified=true` (lines 28-35) and triggers a Resend email if configured (lines 47-76). Reject resets the listing to `is_scaffolded=true`, `is_claimed=false`, `verification_status='manual_review'` (lines 36-40).
- **Dedupe:** None—updates are direct `.eq('id', id)` (line 42).

### Other listing-affecting routes
- **ABN admin decisons:** `POST /api/admin/abn/[id]` (src/app/api/admin/abn/[id]/route.ts:9-48) sets `abn_verifications.status` and updates `businesses.abn_verified/verification_status` based on `action`. Requires numeric path parameter; no additional validation.
- **Deletion:** `DELETE /api/business/[id]/delete` (src/app/api/business/[id]/delete/route.ts:4-18) soft-deletes a listing by setting `is_deleted=true`, `is_active=false`, `deleted_at=timestamp`. No cascades or dedupe.
- **Stripe monetization:** `createCheckoutSessionForBusiness` (src/lib/monetization.ts:103-214) enforces `abn_verified` before allowing upgrades but does not modify `businesses.featured_until`. Webhook handler (`src/app/api/webhooks/stripe/route.ts:1-84`) upserts `business_subscription_status` and logs `payment_audit`.
- **ABN verification API:** `POST /api/abn/verify` (src/app/api/abn/verify/route.ts:1-154) reads ABR data, conditionally logs fallback events, and when `AUTO_APPLY` and `businessId` are provided, upserts an `abn_verifications` row and sets status. It does not alter the `businesses` record’s primary attributes apart from ABN status.

## 3. Data model map
- **`profiles`** (`supabase/schema.sql:120-128`): Each authenticated user has `id` (UUID), `email`, `full_name`, and `role`. Onboarding inserts trainer profiles (src/app/api/onboarding/route.ts:108-113), enabling linkage via `businesses.profile_id`. Admin tools could use `role='admin'` for policy checks.
- **`businesses`** (`supabase/schema.sql:131-157`): Core listing table with encrypted contact info, `suburb_id` (to `suburbs` → `councils` for regions), `abn_verified`, `verification_status`, `resource_type`, `is_scaffolded`, `is_claimed`, `featured_until`, `is_active`, `is_deleted`. Public searches read from it exclusively through RPCs; admin queues query it directly (`src/app/api/admin/queues/route.ts:44-52`).
- **`trainer_specializations` / `trainer_behavior_issues` / `trainer_services`** (`supabase/schema.sql:159-182`): Each table references `business_id` with enum columns `age_specialty`, `behavior_issue`, `service_type`. `trainer_services` also records `is_primary`. `search_trainers` aggregates these arrays (supabase/migrations/20250210153000_search_trainers_accept_key.sql:51-79). Onboarding tries to populate them, but behavior/services writes use wrong table/column names (see mismatches).
- **`abn_verifications`** (`supabase/schema.sql:271-284`): Tracks verification results for each business ABN. Admin queues, ABN verify API, and onboarding read/write this table. `verification_status` fields in `businesses` stay in sync via onboarding/admin endpoints.
- **`reviews`** (`supabase/schema.sql:218-229`): Stores user reviews. `search_trainers` computes `average_rating` and `review_count` from approved rows (supabase/migrations/20250210153000_search_trainers_accept_key.sql:71-79, 93-95). Admin moderation queue fetches unapproved rows (src/app/api/admin/queues/route.ts:22-35).
- **`featured_placements` / `featured_placement_events` / `featured_placement_queue`** (supabase/schema.sql:248-269, supabase/migrations/20251206010000_ai_automation_complete.sql:13-28): Hold paid placement metadata. Cron `/api/admin/featured/expire` updates these tables and logs to `featured_placement_events` (src/app/api/admin/featured/expire/route.ts:64-148). Directory reads only `businesses.featured_until` (src/app/directory/page.tsx:36-49), so these tables currently do not affect UI.
- **Dependent screens:** `/directory` maps `business_name`, `suburb_name`, `region`, `average_rating`, `behavior_issues`, `age_specialties`, `is_featured`, `abn_verified` (src/app/directory/page.tsx:36-133). Homepage uses `SearchResult` shape (`src/lib/api.ts:21-43`). Admin queues rely on `is_scaffolded`, `verification_status`, `abn_verifications.status`, and `reviews.is_approved`.

## 4. Listing states & visibility rules
| State/Flag | Where set | Where read | Effect |
| --- | --- | --- | --- |
| `is_scaffolded` | Onboarding defaults false (supabase schema); scaffold SQL sets true (supabase/phase2_scaffolded.sql); admin approve toggles to false (src/app/api/admin/scaffolded/route.ts:28-35); reject resets to true (lines 36-40). | Admin scaffold GET filters `.eq('is_scaffolded', true)` (src/app/api/admin/scaffolded/route.ts:6-17). | Only admin queue visibility; public RPCs do not filter on it, so scaffolded listings appear publicly once inserted. |
| `is_claimed` | Scaffold SQL false; admin approve true (src/app/api/admin/scaffolded/route.ts:28-35); reject false (lines 36-40). | No public code reads it; only schema column exists. | Currently unused for visibility; would need additional logic to affect UI. |
| `abn_verified` & `verification_status` | Onboarding (src/app/api/onboarding/route.ts:90-133), ABN verify API auto-apply (src/app/api/abn/verify/route.ts:120-154), admin ABN decisions (src/app/api/admin/abn/[id]/route.ts:25-44), scaffold approve auto-verifies (src/app/api/admin/scaffolded/route.ts:28-35). | `search_trainers` orders by `abn_verified` (supabase/migrations/20250210153000_search_trainers_accept_key.sql:131-134); Directory sorts by `is_featured` then `abn_verified` (src/app/directory/page.tsx:36-49); admin queues filter `verification_status='manual_review'` (src/app/api/admin/queues/route.ts:44-52). | Verified listings rank higher on `/directory`; homepage UI attempts to read `trainer.verified` but actual data uses `abn_verified`. |
| `featured_until` | Not written by any current route; column exists on `businesses`. `featured_placements`/`featured_placement_events` updates do not propagate here (src/app/api/admin/featured/expire/route.ts). | `search_trainers` exposes `featured_until` and `is_featured` (supabase/migrations/20250210153000_search_trainers_accept_key.sql:60-68). `/directory` sorts by the derived `is_featured` (src/app/directory/page.tsx:36-49). | Because no process updates `featured_until`, featured badges never appear despite UI support. |
| `is_active` / `is_deleted` | Delete route sets `is_deleted=true`, `is_active=false` (src/app/api/business/[id]/delete/route.ts:4-18); defaults true on insert. | `search_trainers` filters `b.is_active = true AND b.is_deleted = false` (supabase/migrations/20250210153000_search_trainers_accept_key.sql:87-90). | Soft-deleted listings disappear from public searches but remain in the database. |
| Review moderation flags | `reviews.is_approved` exists; `moderatePendingReviews` sets approved/rejected (src/lib/moderation.ts:94-107). Admin review endpoint toggles `is_approved`/`is_rejected` (src/app/api/admin/reviews/[id]/route.ts:38-40). | `search_trainers` counts only `r.is_approved = true` (supabase/migrations/20250210153000_search_trainers_accept_key.sql:71-79). Admin queues fetch `is_approved=false`, `is_rejected=false` (src/app/api/admin/queues/route.ts:22-35). | Approved reviews affect average rating and review count; inconsistent schema (no `is_rejected` column) breaks rejection tracking (see mismatches). |
| `abn_fallback_events` | Recorded for onboarding and ABN verify failures (src/lib/abnFallback.ts:10-26); ABN verify path uses codes `abn_verify_manual_review`, etc. | Admin health routes (e.g., src/lib/alerts.ts:106-134) aggregate fallback rates; `/api/admin/queues` does not read the table directly. | Provides telemetry only; does not change listing visibility. |

## 5. Public display surfaces
### `/directory` (src/app/directory/page.tsx)
- **Data fetch:** Server component calls `supabaseAdmin.rpc('search_trainers', { user_lat: null, user_lng: null, distance_filter: 'any', result_limit: 500, p_key: SUPABASE_PGCRYPTO_KEY })` (lines 13-27). Because coordinates are null, RPC returns all active trainers.
- **Grouping & sorting:** Results grouped by `region` (lines 28-35), sorted inside each group by `(is_featured desc, abn_verified desc, average_rating desc)` (lines 36-49). Featured badge shown when `trainer.is_featured` true (line 93); Verified badge when `trainer.abn_verified` true (line 94). CTA buttons link to `/trainers/{business_id}` and external website/phone (lines 116-130).
- **Dependencies:** Requires `search_trainers` RPC to supply decrypted contact info, arrays of age/issues/services, review stats, and derived flags.

### `/search` (src/app/search/page.tsx)
- **Data fetch:** None. Component reads `sessionStorage.getItem('searchResults')` on mount (lines 14-21) and renders that array. Input field only updates local `query` state (lines 32-39).
- **Filters/sorting:** N/A—placeholder copy states “fully implemented in separate PR” (line 29). Buttons navigate using client-side location changes based on stored IDs (lines 48-55).
- **Effect:** Since nothing writes to `sessionStorage.searchResults`, this page shows no real data.

### `/trainers/[id]` (and `/trainer/[id]`, same component)
- **Data fetch:** Attempts `supabaseAdmin.from('trainers').select('*').eq('id', id).single()` (src/app/trainers/[id]/page.tsx:14-20). Schema has no `trainers` table, so this request fails server-side.
- **Fallbacks:** If `?e2eName` query exists, displays placeholder card (lines 21-28). Otherwise imports a client-only `TrainerFallback` that reads sessionStorage data (lines 32-35).
- **Expected data source:** Tests reference a `getTrainerProfile` helper that should call the `get_trainer_profile` RPC (src/app/trainers/get_trainer_profile.test.ts:15-34), but the page component never exports or invokes such a function. As a result, users never see real listing data here.

### Homepage triage (src/app/page.tsx)
- **Data fetch:** Client form collects `age`, `issues`, `suburbId`, `radius` and calls `apiService.getTriageResults` (lines 88-95). The service invokes Supabase Edge `triage` (supabase/functions/triage/index.ts:47-218), which validates filters and passes them to `search_trainers`. However, the Edge function expects `ageFilters`, `distanceFilter`, etc., not the single `age`/`radius` fields the UI sends, so filters default to “any” distance and no age constraint.
- **Rendering:** Results list shows badges for specialties/issues/services and contact info (lines 216-275). Verified badge uses `trainer.verified` (line 223), but RPC returns `abn_verified`, so the badge never activates.
- **Featured blocks:** There is no separate featured section; homepage only shows the triage result cards assembled client-side.

## 6. Known mismatches proven in code
- **Trainer profile table mismatch:** `/trainers/[id]` queries `.from('trainers')` (src/app/trainers/[id]/page.tsx:14-20), but schema only defines `businesses`. Tests expect a `getTrainerProfile` RPC call (src/app/trainers/get_trainer_profile.test.ts:15-34). Result: SSR profile pages cannot load data.
- **Behavior/service table names:** Onboarding inserts `trainer_behaviors` (src/app/api/onboarding/route.ts:171-177) and uses `service` field when inserting `trainer_services` (lines 179-182), yet schema tables are `trainer_behavior_issues.behavior_issue` and `trainer_services.service_type` (supabase/schema.sql:167-182). Writes to the wrong table/column fail at runtime.
- **Search verified badge mismatch:** Homepage checks `trainer.verified` (src/app/page.tsx:223-227), but `search_trainers` returns `abn_verified` (supabase/migrations/20250210153000_search_trainers_accept_key.sql:31-35). Verified badge never shows.
- **Age/distance filters:** UI sends `{ age, radius }` (src/app/page.tsx:88-95), but Edge function expects `ageFilters` and `distanceFilter` (supabase/functions/triage/index.ts:47-118). Submitted filters are ignored.
- **`trainer_behavior_issues` vs `trainer_behaviors` schema:** No `trainer_behaviors` table exists. Imports or onboarding attempts to insert will error.
- **`reviews.is_rejected`**: Moderation logic reads/writes `is_rejected` (src/lib/moderation.ts:69-107; src/app/api/admin/reviews/[id]/route.ts:38-40), yet schema lacks that column (`supabase/schema.sql:218-229`). Rejection updates fail.
- **Public autocomplete fields:** `/api/public/autocomplete` selects `business_name` and `suburb` from `businesses` (src/app/api/public/autocomplete/route.ts:31-55), but those columns don’t exist—the names live in RPC results. Endpoint cannot succeed.
- **Featured flag propagation:** Directory sorts by `is_featured` derived from `businesses.featured_until` (src/app/directory/page.tsx:36-49), yet no route updates `featured_until`. Payment flows update `featured_placements` only (src/app/api/admin/featured/expire/route.ts:64-148), so featured badges never reflect purchases.
- **Promote page selects nonexistent column:** `loadBusiness` requests `suburb_name` from `businesses` (src/app/promote/page.tsx:19-31), but schema lacks that column, so the query fails.

## 7. Seed/import mechanism (current reality)
1. **Prepare `DOCS/phase2_scraper_targets.csv`:** Each row must include `url`, `name`, `phone`, `email`, `suburb`, `lga`, `age_hint`, `issue_hint`, `service_hint`, `abn` (see headers consumed by `csv.DictReader` in scripts/run_phase2_scraper.py:62-75). Fields like `age_hint` are used to map into canonical enums via helper functions (`map_age`, `map_issue`, `map_service` at lines 43-53).
2. **Generate JSON:** Run `SCRAPER_ENABLED=true python scripts/run_phase2_scraper.py` to produce `supabase/phase2_scraped.json`, containing objects with `age_specialties`, `behavior_issues`, `primary_service`, `secondary_services`, `is_scaffolded=true`, `is_claimed=false`, `resource_type='trainer'`.
3. **Render SQL:** With the same env flag, run `python scripts/apply_phase2_scaffolded.py` to emit `supabase/phase2_scaffolded.sql`. The SQL wraps inserts in `BEGIN/COMMIT` (lines 22-63), writing `businesses`, `trainer_specializations`, `trainer_behavior_issues`, `trainer_services`, and `abn_verifications`. Contact data is encrypted via `pgp_sym_encrypt` (lines 24-36). Each record uses `currval('businesses_id_seq')` to relate child rows.
4. **Apply seed:** Execute the SQL against the Supabase/Postgres instance. No tooling automates this step; the repo relies on manual execution. There are no dedupe checks, so rerunning the script creates duplicate scaffolded listings.

## Operator translation
From an operator’s perspective, new trainer submissions arrive via `/api/onboarding`, scaffolded imports land in the “Scaffolded Listings” admin queue (`GET /api/admin/scaffolded`), and ABN/manual review queues aggregate unverified or manual-review cases (`/api/admin/queues`). Approving a scaffolded listing flips it to claimed/verified and sends an email, but featured upgrades or verified badges may not show publicly because the UI reads fields (e.g., `featured_until`, `trainer.verified`) that never update. Reviews flow through the moderation queue, yet rejection toggles currently fail because the schema lacks `is_rejected`, so operators see pending reviews that can’t be fully rejected. Public-facing pages—directory and homepage triage—pull directly from the `search_trainers` RPC, so any listing present in `businesses` with `is_active=true` is effectively “live,” even if it still carries `is_scaffolded=true`.
