{
  "timestamp": "2025-12-12T17:07:53.681Z",
  "sha": "f091995db6d54bd93e2f35fb8b9ef709f3617b95",
  "target": "staging",
  "envTarget": "staging",
  "dnsStatus": "WARN",
  "counts": {
    "pass": 16,
    "warn": 2,
    "skip": 10,
    "fail": 0
  },
  "results": [
    {
      "name": "verify:phase9b",
      "status": "PASS",
      "command": "npm run verify:phase9b",
      "durationMs": 46625,
      "output": "> dtd@1.0.0 verify:phase9b\n> tsx scripts/verify_phase9b.ts\n\n========================================\nPhase 9B Verification Harness\n========================================\n\n[PASS] Environment Variables: All required vars present (3 checked)\n\n[BUILD] Running npm run build...\n[PASS] Build (npm run build): Next.js build succeeded\n\n[TESTS] Running npm test...\n[PASS] Tests (npm test): Tests passed (unknown tests)\n\n[DB] Connecting to Supabase...\n[PASS] Database Schema: All required tables present (payment_audit, business_subscription_status)\n\n\n---\n\n## Automated Verification Snapshot – Phase 9B\n\n- **Date:** 2025-12-12T17:06:15.566Z\n- **Checks:**\n  - ✅ Environment Variables: All required vars present (3 checked)\n  - ✅ Build (npm run build): Next.js build succeeded\n  - ✅ Tests (npm test): Tests passed (unknown tests)\n  - ✅ Database Schema: All required tables present (payment_audit, business_subscription_status)\n\n**Overall:** ✅ AUTOMATION PASS\n> Note: Manual Stripe drill (Steps 4.1, 4.3) and production UI checks (Step 7) still required.\n> Use `DOCS/automation/PHASE_9B_OPERATOR_CHECKLIST.md` to continue."
    },
    {
      "name": "lint",
      "status": "PASS",
      "command": "npm run lint",
      "durationMs": 19693,
      "output": "> dtd@1.0.0 lint\n> eslint ."
    },
    {
      "name": "test",
      "status": "PASS",
      "command": "npm run test",
      "durationMs": 5784,
      "output": "> dtd@1.0.0 test\n> vitest run\n\n\n\u001b[1m\u001b[46m RUN \u001b[49m\u001b[22m \u001b[36mv4.0.15 \u001b[39m\u001b[90m/Users/carlg/Documents/PROJECTS/Project-dev/DTD\u001b[39m\n\n \u001b[32m✓\u001b[39m src/app/api/admin/ops/overrides/route.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 124\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/app/directory/fetchDirectoryRegions.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 440\u001b[2mms\u001b[22m\u001b[39m\n     \u001b[33m\u001b[2m✓\u001b[22m\u001b[39m passes p_key from env when SUPABASE_PGCRYPTO_KEY is set \u001b[33m 423\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/app/trainers/get_trainer_profile.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 645\u001b[2mms\u001b[22m\u001b[39m\n     \u001b[33m\u001b[2m✓\u001b[22m\u001b[39m passes p_key from env when SUPABASE_PGCRYPTO_KEY is set \u001b[33m 637\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/app/api/onboarding/route.integration.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 643\u001b[2mms\u001b[22m\u001b[39m\n     \u001b[33m\u001b[2m✓\u001b[22m\u001b[39m stores matched_json parsed object and status=verified for Active ABN \u001b[33m 630\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/app/api/abn/verify/route.test.ts \u001b[2m(\u001b[22m\u001b[2m3 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 637\u001b[2mms\u001b[22m\u001b[39m\n     \u001b[33m\u001b[2m✓\u001b[22m\u001b[39m returns verification results and does not write when AUTO_APPLY=false \u001b[33m 620\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/app/api/onboarding/route.test.ts \u001b[2m(\u001b[22m\u001b[2m1 test\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 634\u001b[2mms\u001b[22m\u001b[39m\n     \u001b[33m\u001b[2m✓\u001b[22m\u001b[39m calls ABR and persists matched_json when creating a business \u001b[33m 633\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/alerts.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 1…"
    },
    {
      "name": "smoke",
      "status": "PASS",
      "command": "npm run smoke",
      "durationMs": 4237,
      "output": "> dtd@1.0.0 smoke\n> vitest run tests/smoke\n\n\n\u001b[1m\u001b[46m RUN \u001b[49m\u001b[22m \u001b[36mv4.0.15 \u001b[39m\u001b[90m/Users/carlg/Documents/PROJECTS/Project-dev/DTD\u001b[39m\n\n \u001b[32m✓\u001b[39m tests/smoke/error-logging.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 30\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/admin-pages.test.tsx \u001b[2m(\u001b[22m\u001b[2m4 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 35\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/trainers.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 9\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/emergency-api.test.ts \u001b[2m(\u001b[22m\u001b[2m3 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 23\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/alerts.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 869\u001b[2mms\u001b[22m\u001b[39m\n\n\u001b[2m Test Files \u001b[22m \u001b[1m\u001b[32m5 passed\u001b[39m\u001b[22m\u001b[90m (5)\u001b[39m\n\u001b[2m      Tests \u001b[22m \u001b[1m\u001b[32m13 passed\u001b[39m\u001b[22m\u001b[90m (13)\u001b[39m\n\u001b[2m   Start at \u001b[22m 04:06:42\n\u001b[2m   Duration \u001b[22m 2.78s\u001b[2m (transform 1.99s, setup 0ms, import 2.70s, tests 965ms, environment 5ms)\u001b[22m"
    },
    {
      "name": "e2e",
      "status": "PASS",
      "command": "npm run e2e",
      "durationMs": 42363,
      "output": "> dtd@1.0.0 e2e\n> playwright test\n\n\nRunning 8 tests using 4 workers\n\n  ✓  1 [chromium] › tests/e2e/alerts-snapshot.spec.ts:3:1 › alerts snapshot healthy baseline (3.7s)\n  ✓  2 [chromium] › tests/e2e/emergency.spec.ts:5:1 › Emergency controls toggle state and capture screenshot (11.8s)\n  ✓  3 [chromium] › tests/e2e/admin-dashboards.spec.ts:86:3 › Admin dashboards › AI health dashboard shows override state (13.4s)\n  ✓  4 [chromium] › tests/e2e/monetization.spec.ts:178:3 › Monetization upgrade flow › provider upgrade and admin subscription tab (18.7s)\n  ✓  6 [chromium] › tests/e2e/admin-dashboards.spec.ts:99:3 › Admin dashboards › Cron health dashboard renders schedule snapshot (5.4s)\n  ✓  7 [chromium] › tests/e2e/monetization.spec.ts:203:3 › Monetization upgrade flow › hides upgrade CTA when feature flag disabled (1.3s)\n  ✓  8 [chromium] › tests/e2e/monetization.spec.ts:209:3 › Monetization upgrade flow › requires ABN verification before upgrade (686ms)\n  ✓  5 [chromium] › tests/e2e/search-and-trainer.spec.ts:19:3 › Search → Trainer profile › navigates from search results to trainer profile (19.0s)\n\n  8 passed (40.4s)"
    },
    {
      "name": "preprod (staging)",
      "status": "PASS",
      "command": "./scripts/preprod_verify.sh",
      "durationMs": 20316,
      "output": "========================================\nRunning Type Check\n\n> dtd@1.0.0 type-check\n> tsc --noEmit\n\n[PASS] Type Check\n========================================\nRunning Smoke Tests\n\n> dtd@1.0.0 smoke\n> vitest run tests/smoke\n\n\n\u001b[1m\u001b[46m RUN \u001b[49m\u001b[22m \u001b[36mv4.0.15 \u001b[39m\u001b[90m/Users/carlg/Documents/PROJECTS/Project-dev/DTD\u001b[39m\n\n \u001b[32m✓\u001b[39m tests/smoke/error-logging.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 36\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/admin-pages.test.tsx \u001b[2m(\u001b[22m\u001b[2m4 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 53\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/trainers.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 16\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/emergency-api.test.ts \u001b[2m(\u001b[22m\u001b[2m3 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 23\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m tests/smoke/alerts.test.ts \u001b[2m(\u001b[22m\u001b[2m2 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[33m 952\u001b[2mms\u001b[22m\u001b[39m\n\n\u001b[2m Test Files \u001b[22m \u001b[1m\u001b[32m5 passed\u001b[39m\u001b[22m\u001b[90m (5)\u001b[39m\n\u001b[2m      Tests \u001b[22m \u001b[1m\u001b[32m13 passed\u001b[39m\u001b[22m\u001b[90m (13)\u001b[39m\n\u001b[2m   Start at \u001b[22m 04:07:35\n\u001b[2m   Duration \u001b[22m 1.92s\u001b[2m (transform 1.73s, setup 0ms, import 2.45s, tests 1.08s, environment 1ms)\u001b[22m\n\n[PASS] Smoke Tests\n========================================\nRunning Lint\n\n> dtd@1.0.0 lint\n> eslint .\n\n[PASS] Lint\n========================================\nRunning Doc Divergence Detector\nDoc Divergence Detector: all checks passed ✅\n[PASS] Doc Divergence Detector\n========================================\nRunning Env Ready Check\n========================================\nRu…"
    },
    {
      "name": "check_env_ready staging",
      "status": "PASS",
      "command": "./scripts/check_env_ready.sh staging",
      "durationMs": 121,
      "output": "========================================\nRunning Env Ready Check (target: staging)\nAll required variables are set.\n[PASS] Env Ready Check"
    },
    {
      "name": "alerts dry-run",
      "status": "PASS",
      "command": "npx tsx scripts/run_alerts_email.ts --dry-run",
      "durationMs": 2083,
      "output": "DRY RUN ALERT SUMMARY:\n- [CRITICAL] emergency_cron: Emergency cron has no recorded successes"
    },
    {
      "name": "DB target",
      "status": "PASS",
      "durationMs": 98,
      "details": {
        "urlHost": "db.xqytwtmdilipxnjetvoe.supabase.co",
        "urlDatabase": "postgres",
        "runtimeHost": "2406:da18:243:7427:54d8:9466:9e8a:e018/128",
        "runtimeDatabase": "postgres",
        "runtimeRole": "postgres",
        "runtimePort": 5432
      }
    },
    {
      "name": "ABN fallback rate",
      "status": "PASS",
      "durationMs": 303,
      "details": {
        "fallbackCount24h": 1,
        "verifiedCount24h": 6,
        "fallbackCount7d": 1,
        "threshold": 0.15
      }
    },
    {
      "name": "Database schema presence",
      "status": "PASS",
      "durationMs": 816,
      "details": {
        "missing": []
      }
    },
    {
      "name": "RLS status",
      "status": "PASS",
      "durationMs": 454,
      "details": {
        "missing": [],
        "tableStatuses": [
          {
            "table": "businesses",
            "rlsEnabled": true
          },
          {
            "table": "profiles",
            "rlsEnabled": true
          },
          {
            "table": "abn_verifications",
            "rlsEnabled": true
          },
          {
            "table": "abn_fallback_events",
            "rlsEnabled": true
          },
          {
            "table": "ops_overrides",
            "rlsEnabled": true
          }
        ]
      }
    },
    {
      "name": "Policy coverage",
      "status": "PASS",
      "durationMs": 456,
      "details": {
        "missing": [],
        "overlyPermissive": [],
        "perTablePolicies": [
          {
            "table": "businesses",
            "policies": [
              {
                "name": "Active businesses are viewable by everyone",
                "permissive": true,
                "usingClause": "(is_active = true)",
                "command": "select"
              },
              {
                "name": "Admins can view all businesses",
                "permissive": true,
                "usingClause": "(EXISTS ( SELECT 1\n   FROM profiles\n  WHERE ((profiles.id = auth.uid()) AND (profiles.role = 'admin'::user_role))))",
                "command": "select"
              },
              {
                "name": "Trainers can insert own businesses",
                "permissive": true,
                "usingClause": "true",
                "command": "insert"
              },
              {
                "name": "Trainers can update own businesses",
                "permissive": true,
                "usingClause": "(auth.uid() = profile_id)",
                "command": "update"
              }
            ]
          },
          {
            "table": "profiles",
            "policies": [
              {
                "name": "Admins can view all profiles",
                "permissive": true,
                "usingClause": "(EXISTS ( SELECT 1\n   FROM profiles profiles_1\n  WHERE ((profiles_1.id = auth.uid()) AND (profiles_1.role = 'admin'::user_role))))",
                "command": "select"
              },
              {
                "name": "Users can update own profile",
                "permissive": true,
                "usingClause": "(auth.uid() = id)",
                "command": "update"
              },
              {
                "name": "Users can view own profile",
                "permissive": true,
                "usingClause": "(auth.uid() = id)",
                "command": "select"
              }
            ]
          },
          {
            "table": "abn_verifications",
            "policies": [
              {
                "name": "service-role-abn-verifications",
                "permissive": true,
                "usingClause": "(auth.role() = 'service_role'::text)",
                "command": "all"
              }
            ]
          },
          {
            "table": "abn_fallback_events",
            "policies": [
              {
                "name": "service-role-abn-fallback-events",
                "permissive": true,
                "usingClause": "(auth.role() = 'service_role'::text)",
                "command": "all"
              }
            ]
          },
          {
            "table": "ops_overrides",
            "policies": [
              {
                "name": "service-role-ops-overrides",
                "permissive": true,
                "usingClause": "(auth.role() = 'service_role'::text)",
                "command": "all"
              }
            ]
          }
        ]
      }
    },
    {
      "name": "Migration parity",
      "status": "PASS",
      "durationMs": 93,
      "details": {
        "totalMigrations": 13,
        "appliedCount": 11,
        "checkedAfterBaseline": 6,
        "missing": [],
        "recentApplied": [
          "20251209093000_add_latency_metrics (name: add_latency_metrics, appliedAt: not tracked)",
          "20251209101000_create_payment_tables (name: create_payment_tables, appliedAt: not tracked)",
          "20251212111500_create_abn_fallback_events (name: create_abn_fallback_events, appliedAt: not tracked)",
          "20251212113000_secure_abn_tables (name: secure_abn_tables, appliedAt: not tracked)",
          "20251212114500_create_ops_overrides (name: create_ops_overrides, appliedAt: not tracked)"
        ],
        "baselineVersion": 20251100000000,
        "timestampSource": "schema_migrations has no inserted_at column"
      }
    },
    {
      "name": "DNS root → Vercel",
      "status": "WARN",
      "durationMs": 75,
      "details": {
        "expected": "cname.vercel-dns.com.",
        "cnameRecords": [],
        "aRecords": [
          "64.29.17.65",
          "64.29.17.1"
        ]
      }
    },
    {
      "name": "DNS staging → Vercel",
      "status": "WARN",
      "durationMs": 51,
      "details": {
        "expected": "cname.vercel-dns.com.",
        "cnameRecords": [],
        "aRecords": [
          "64.29.17.1",
          "216.198.79.1"
        ]
      }
    },
    {
      "name": "Production curl",
      "status": "PASS",
      "durationMs": 106,
      "output": "HTTP/2 404"
    },
    {
      "name": "Monetization flags (staging env)",
      "status": "PASS",
      "durationMs": 0,
      "details": {
        "FEATURE_MONETIZATION_ENABLED": "1",
        "NEXT_PUBLIC_FEATURE_MONETIZATION_ENABLED": "1"
      }
    },
    {
      "name": "Secrets alignment (.env vs Vercel) – item 4c",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Requires Vercel dashboard + secret rotation approvals."
      }
    },
    {
      "name": "Stripe monetization drill – item 8b",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Live Stripe payment and webhook replay need human supervision."
      }
    },
    {
      "name": "Production payouts + compliance review – item 9b",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Requires finance + compliance teams sign-off."
      }
    },
    {
      "name": "Production admin toggles – item 10c",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Vercel/Stripe toggles enforced during final go/no-go."
      }
    },
    {
      "name": "Stripe live upgrade path – item 10d",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Must be exercised with real card + observers."
      }
    },
    {
      "name": "Stripe invoice sanity – item 10f",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Needs invoice PDF inspection + accounting approval."
      }
    },
    {
      "name": "Production governance approvals – item 11b",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Board/governance approvals cannot be automated."
      }
    },
    {
      "name": "Legal sign-off + comms – item 11c",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Requires legal + comms leads to sign launch docs."
      }
    },
    {
      "name": "Production monetization flags – item 10e",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Needs Vercel production env inspect via MCP/browser."
      }
    },
    {
      "name": "Production DNS evidence – item 11a",
      "status": "SKIP",
      "durationMs": 0,
      "details": {
        "reason": "Needs DNS provider screenshots/API (MCP) for production domain."
      }
    }
  ]
}